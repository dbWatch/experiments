<?xml version="1.0" encoding="UTF-8"?>
<properties>
	<asproperties>
		<name>Generic_http_alert</name>
		<version>1</version>
		<company>dbwatch.no</company>
		<group>no.dbwatch</group>
		<artifactid>Generic_http_alert</artifactid>
	</asproperties>
	<property>
		<key name="status" entityType="status"/>
		<key>details</key>		
		<display-name>Generic HTTP alert</display-name>
		<description>Test a HTTP URL for </description>
		<category>Maintenance</category>
		<parameters>
			<parameter name="URL" default="http://www.dbwatch.com/" type="string" description="URL to test"/>
			<parameter name="findstring" default="Managing databases means more than just monitoring" type="string" description="String to look for in webpage body"/>
		</parameters> 
		<compatability>instance</compatability>
		
		<installable>
			<key>Generic_http_alert</key>
			<compatability><![CDATA[.[maj_version ='11' | maj_version = '12']/.[databasetype='oracle']]]></compatability>
		</installable>
		<default-schedule>4h</default-schedule>
		<valid-for>1h</valid-for>
		<compatability>.[source like "Generic_http_alert"]/instance</compatability>
		<entityType>scheduledtask</entityType>
		
		<value engine="javascript">
			<![CDATA[
			try {
				var status = 1;
            	var msg = "Why wasnt this message changed?";	
				var url_addr = URL;
				
				
				var urldata = http.get( url_addr );
				var err_code = urldata.status;
				var find_string = findstring;
				var rows = urldata.body;
				var found = 0;
				if (err_code == 200) {
					status = 0;
					msg = "URL OK";
				}
				else if (err_code != 200) {
					status = 2;
					msg "URL Error: + err_code";
				}
				for(i = 0; i < rows.length; i++) {
            		var line = rows[i].get(0).asString();
            		if (line.contains(find_string)) {
            			found = 1;
            		}
            	}				
            	if ((found == 1) && (status = 0 )) {
            		msg = msg + ", String found";
            	}
            	else if ((found = 0) && (status = 0 )) {
            		status = 1;
            		msg = msg + ", String NOT found";
            	}
            		
				result.setStatus(status, msg);   
			}
			catch (err) {
				result.setStatus(2, err.message);       
			}
			]]>
		
		</value>
	</property>
</properties>
